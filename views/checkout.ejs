<%- include('partials/header', { title: 'Checkout' }) %>

<section class="checkout container">
  <h2>Checkout</h2>

  <div id="cart-summary">
    <% cart.forEach(item => { %>
      <p><%= item.name %> x <%= item.qty %> = ₹<%= item.price * item.qty %></p>
    <% }) %>
    <h3>Total: ₹<%= totalAmount %></h3>
  </div>

  <!-- Stripe Card Element -->
  <div id="card-element" class="my-3 p-3 border rounded"></div>
  <div id="card-errors" class="text-danger mb-3"></div>

  <button id="payBtn" class="btn btn-primary">Pay Now</button>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const checkoutBtn = document.getElementById('payBtn');
  checkoutBtn.onclick = async () => {
    const res = await fetch('/payment/create-order', { method: 'POST' });
    const order = await res.json();

    const options = {
      key: "<%= razorpayKey %>",
      amount: order.amount,
      currency: order.currency,
      name: "Buyhatke Candles",
      order_id: order.id,
      handler: async function (response) {
        const verify = await fetch('/payment/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(response)
        });
        const result = await verify.json();
        if(result.success) {
          alert('Payment successful! Order ID: ' + result.orderId);
          window.location.href = '/user/orders';
        } else {
          alert('Payment failed!');
        }
      }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  };
</script>


<%- include('partials/footer') %>
