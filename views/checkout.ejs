<%- include('partials/header', { title: 'Checkout' }) %>

<section class="checkout container">
  <h2>Checkout</h2>

  <div id="cart-summary">
    <% cart.forEach(item => { %>
      <p><%= item.name %> x <%= item.qty %> = ₹<%= item.price * item.qty %></p>
    <% }) %>
    <h3>Total: ₹<%= totalAmount %></h3>
  </div>

  <button id="payBtn" class="btn btn-primary">Pay Now</button>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById('payBtn').onclick = async () => {
    try {
      // Create Razorpay order from server
      const res = await fetch('/payment/create-order', { method: 'POST' });
      const order = await res.json();

      // Razorpay checkout options
      const options = {
        key: "<%= razorpayKey %>",
        amount: order.amount,
        currency: order.currency,
        name: "Buyhatke Candles",
        order_id: order.id,
        handler: async function (response) {
          // Verify payment on server
          const verify = await fetch('/payment/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(response)
          });

          const resultHTML = await verify.text();
          document.open();
          document.write(resultHTML);
          document.close();
        },
        theme: {
          color: "#f973b0" // optional: matches your pink theme
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();

    } catch (err) {
      console.error(err);
      alert('Failed to initiate payment. Please try again.');
    }
  };
</script>

<%- include('partials/footer') %>
