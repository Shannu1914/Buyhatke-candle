<%- include('partials/header', { title: 'Checkout' }) %>

<section class="checkout container" style="padding:40px 20px;">
  <h2>Checkout</h2>

  <!-- Cart Summary -->
  <div id="cart-summary" style="margin-bottom:20px;">
    <% cart.forEach(item => { %>
      <p><%= item.name %> x <%= item.qty %> = ₹<%= item.price * item.qty %></p>
    <% }) %>
    <h3>Total: ₹<%= totalAmount %></h3>
  </div>

  <!-- Address Form -->
  <form id="checkoutForm" style="background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px;">
    <h3>Shipping Details</h3>

    <label>Name</label>
    <input type="text" name="name" required class="form-control"/>

    <label>Email</label>
    <input type="email" name="email" required class="form-control"/>

    <label>Phone</label>
    <input type="text" name="phone" required class="form-control"/>

    <label>Address</label>
    <input type="text" name="address" required class="form-control"/>

    <label>City</label>
    <input type="text" name="city" required class="form-control"/>

    <label>State</label>
    <input type="text" name="state" required class="form-control"/>

    <label>Pincode</label>
    <input type="text" name="pincode" required class="form-control"/>
  </form>

  <button id="payBtn" class="btn btn-primary">Pay Now</button>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById('payBtn').onclick = async () => {
    try {
      // Grab address form data
      const form = document.getElementById('checkoutForm');
      const formData = Object.fromEntries(new FormData(form).entries());

      // 1. Create Razorpay order from server (send address too!)
      const res = await fetch('/payment/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      const order = await res.json();

      // 2. Razorpay checkout options
      const options = {
        key: "<%= razorpayKey %>",
        amount: order.amount,
        currency: order.currency,
        name: "Buyhatke Candles",
        order_id: order.id,
        handler: async function (response) {
          // 3. Verify payment on server with order + address
          const verify = await fetch('/payment/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...response, address: formData })
          });

          const resultHTML = await verify.text();
          document.open();
          document.write(resultHTML);
          document.close();
        },
        prefill: {
          name: formData.name,
          email: formData.email,
          contact: formData.phone
        },
        theme: { color: "#f973b0" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      console.error(err);
      alert('Failed to initiate payment. Please try again.');
    }
  };
</script>

<%- include('partials/footer') %>
